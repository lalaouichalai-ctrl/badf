<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Cartes Bancaires - Banque de France</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="shared.js"></script>
    <style>
        /* Styles d'en-tête Site B */
        header {
            background-color: #003366;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info, .account-info, .advisor { margin-right: 20px; }
        .user-info span { display: block; }
        .account-info { text-align: right; }
        .account-info span { display: block; font-weight: bold; }
        .account-info .balance { font-size: 1.2em; color: #ffcc00; } /* Jaune pour le solde */

        nav ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 20px; font-weight: bold; }
        nav a { text-decoration: none; color: #003366; }
        nav { background-color: #e0e6ed; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; }

        /* Styles de la carte et du conteneur */
        main { display: flex; padding: 30px; gap: 40px; }
        .main-content { flex: 3; }
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .right-panel button { padding: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .card-container { display: flex; justify-content: center; margin: 30px 0; }
        .bank-card {
            width: 350px; height: 200px; background: linear-gradient(135deg, #003366, #3b5998); /* Bleu marine Site B */
            color: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 20px rgba(0, 51, 102, 0.4);
            position: relative;
        }
        .card-type { font-size: 1.5em; font-weight: bold; text-align: right; margin-bottom: 20px; }
        .card-number { font-size: 1.8em; letter-spacing: 3px; margin-bottom: 25px; font-family: 'Courier New', monospace; }
        .card-footer { display: flex; justify-content: space-between; font-size: 0.9em; }
        .expiry-date span { font-size: 1.2em; }
        .card-holder { text-transform: uppercase; font-weight: bold; }
        #status-card-box { text-align: center; margin-top: 30px; }
        
        /* Styles spécifiques au statut de la carte */
        .card-status-text { font-weight: bold; margin-top: 15px; }
        .status-actif { color: #2ecc71; } /* Vert */
        .status-bloquee { color: #e74c3c; } /* Rouge */
        
        /* Boutons de bascule */
        #toggle-card-btn {
            background: #003366; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            margin-top: 20px;
        }
        .btn-danger { background: #d9534f !important; } /* Rouge pour désactiver */
    </style>
</head>
<body>
<header>
    <div class="top-bar">
        <div class="user-info"><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Banque_de_France_Logo.svg/1280px-Banque_de_France_Logo.svg.png height=85 width=155>
            <span>Bienvenue <strong id="user-name-header">...</strong></span>
            <span id="last-conn" class="last-conn">Dernière connexion...</span>
        </div>
        <div class="account-info">
            <span class="balance" id="client-solde">0,00 €</span>
        </div>
        <div class="advisor">
            <p>Votre conseiller<br><strong id="advisor-name">Chargement...</strong></p>
            <a href="index.html" class="status">Se déconnecter</a>
        </div>
    </div>
</header>

<nav>
    <ul>
        <li><a href="dashboard.html">VOS COMPTES ET PRODUITS</a></li>
        <li><a href="historique.html">OPERATIONS COURANTES</a></li>
        <li><a href="profil.html">PROFIL ET DOCUMENTS</a></li>
    </ul>
    <input type="search" placeholder="Rechercher" class="search-bar">
</nav>

<main>
    <div class="main-content">
        <h2>Gestion de ma Carte Bancaire</h2>

        <div class="card-container">
            <div class="bank-card" id="bank-card">
                <div class="card-type" id="card-type">VISA</div>
                <div class="card-number" id="card-number">XXXX XXXX XXXX XXXX</div>
                <div class="card-footer">
                    <div class="card-holder" id="card-holder-name">NOM DU TITULAIRE</div>
                    <div class="expiry-date">Valide jusqu'à : <span id="expiry-date">MM/AA</span></div>
                </div>
            </div>
        </div>
        
        <div id="status-card-box" style="text-align: center;">
            <p id="card-status-text" class="card-status-text">Chargement du statut...</p>
            <button id="toggle-card-btn" disabled>Chargement...</button>
            <p style="margin-top: 10px; font-size: 13px; color: #555;">La désactivation temporaire de votre carte est immédiate. Vous pouvez la réactiver à tout moment.</p>
        </div>
    </div>

    <aside class="right-panel">
        <a href="dashboard.html"><button>Synthèse des comptes</button></a>
        <a href="virement.html"><button>Faire un virement</button></a>
        <button onclick="location.href='profil.html'">PROFIL</button>
        <a href="historique.html"><button>Historique des opérations</button></a>
        <button class="sav" onclick="alert('Contactez votre conseiller pour toute question sur la carte.')">VOTRE ESPACE SAV</button>
    </aside>
</main>

<footer>
    <p>© BANQUE DE FRANCE - 39 Rue Croix des Petits Champs, 75001 Paris, France </p>
</footer>


<script>

// Fonction pour mettre à jour l'affichage de la carte et du bouton
function updateCardUI(user, toggleBtn) {
    const statusEl = document.getElementById('card-status-text');
    // NOTE: On suppose que la carte est stockée sous user.carte.active
    const status = user.carte && user.carte.active; 
    
    toggleBtn.classList.remove('btn-primary', 'btn-danger');

    if (status) {
        statusEl.textContent = "Statut : CARTE ACTIVE";
        statusEl.className = 'card-status-text status-actif';
        toggleBtn.textContent = "Bloquer Temporairement la Carte";
        toggleBtn.classList.add('btn-danger'); // Rouge pour Bloquer
    } else {
        statusEl.textContent = "Statut : CARTE BLOQUÉE TEMPORAIREMENT";
        statusEl.className = 'card-status-text status-bloquee';
        toggleBtn.textContent = "Réactiver la Carte";
        toggleBtn.classList.add('btn-primary'); // Bleu pour Réactiver
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    
    // 1. Récupérer les données les plus fraîches de Firebase
    // ⚠️ CORRECTION : Utilisation de la fonction checkAuth (corrigée dans shared.js)
    const user = await checkAuth(); 
    const toggleBtn = document.getElementById('toggle-card-btn');
    
    if (!user) {
        toggleBtn.textContent = "Session expirée. Veuillez vous reconnecter.";
        return;
    }

    // --- Mise à jour de l'UI de l'en-tête (Données Firestore) ---
    // Affichage du prénom et nom (comme géré dans checkAuth pour la cohérence)
    const nameParts = user.name.split(' ');
    const display = nameParts.length > 1 ? `${nameParts[0]} ${nameParts[1]}` : user.name;

    document.getElementById('user-name-header').textContent = display;
    document.getElementById('client-solde').textContent = formatCurrency(user.solde);
    document.getElementById('advisor-name').textContent = user.advisor || 'Non attribué';
    document.getElementById('last-conn').textContent = `Dernière connexion le ${user.lastConnection}`;
    
    // 2. Affichage de la carte et du statut
    if (user.carte && user.carte.numero) {
        // Affichage des détails de la carte
        const formattedNumber = user.carte.numero.match(/.{1,4}/g).join(' ');
        document.getElementById('card-number').textContent = formattedNumber;
        document.getElementById('card-holder-name').textContent = user.name.toUpperCase();
        document.getElementById('expiry-date').textContent = user.carte.expiration;
        document.getElementById('card-type').textContent = user.carte.cardType || 'VISA';

        // Affichage initial du statut
        updateCardUI(user, toggleBtn);
        toggleBtn.disabled = false; // Activation du bouton

        // 3. Gestionnaire d'événement ASYNCHRONE pour la bascule
        toggleBtn.addEventListener('click', async () => {
            const isActivating = !user.carte.active; 
            
            toggleBtn.disabled = true; 
            toggleBtn.textContent = isActivating ? "Réactivation en cours..." : "Désactivation en cours...";

            try {
                // Bascule de l'état local
                user.carte.active = isActivating; 
                
                // Sauvegarde ASYNCHRONE sur Firebase
                // ⚠️ CORRECTION : Utilisation de la fonction updateUser (disponible dans shared.js)
                const success = await updateUser(user); 
                
                if (success) {
                    // Mise à jour de l'UI après succès de la sauvegarde
                    updateCardUI(user, toggleBtn);
                } else {
                    throw new Error("Échec de la sauvegarde.");
                }
                
            } catch (error) {
                console.error("Échec de la mise à jour de la carte sur Firebase.", error);
                alert("Erreur: Impossible de mettre à jour le statut de la carte. Veuillez vérifier votre connexion.");
                
                // Annuler la bascule locale si la sauvegarde échoue
                user.carte.active = !isActivating; 
            } finally {
                // S'assurer que le bouton revient à l'état cliquable
                toggleBtn.disabled = false;
                updateCardUI(user, toggleBtn); // Afficher le bon état final
            }
        });
    } else {
        document.getElementById('bank-card').innerHTML = '<div style="padding: 50px; text-align: center; color: white;">Aucune carte enregistrée.</div>';
        document.getElementById('card-status-text').textContent = "Statut : NON ATTRIBUÉ";
        toggleBtn.textContent = "Carte non trouvée.";
        toggleBtn.disabled = true;
    }
});
</script>
</body>
</html>