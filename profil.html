<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mon Profil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
      <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
<header>
  <div class="top-bar">
    <div class="user-info"><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Banque_de_France_Logo.svg/1280px-Banque_de_France_Logo.svg.png height=85 width=155>
      <span>Bienvenue Monsieur / Madame</span>
      <span class="last-conn">Dernière connexion...</span>
      <span class="status">Déconnexion</span>
    </div>
    <div class="account-info">
      <span class="balance" id="client-solde">0,00 €</span>
      <span class="gains">Gains en cours</span>
      <span class="mail">Votre messagerie</span>
    </div>
    <div class="advisor">
      <p>Votre conseiller<br><strong id="advisor-name">Chargement...</strong></p>
    </div>
  </div>
</header>

<nav>
  <ul>
    <li><a href="dashboard.html">VOS COMPTES ET PRODUITS</a></li>
    <li><a href="virement.html">OPERATIONS COURANTES</a></li>
    <li><a href="profil.html">S’INFORMER OU SOUSCRIRE</a></li>
  </ul>
  <input type="search" placeholder="Rechercher" class="search-bar">
</nav>

<main>
  <h2>Mon Profil et Mes Informations Personnelles</h2>

  <div class="account-block">
    <h4>Informations du Compte</h4>
    <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
      <label>Nom Complet :</label> <p id="profile-name"></p>
      <label>Code Client :</label> <p id="profile-client-code"></p>
      <label>PIN (Masqué) :</label> <p>******</p>
      <label>Conseiller Attitré :</label> <p id="profile-advisor"></p>
    </div>
  </div>

  <div class="account-block" style="margin-top: 20px;">
    <h4>Coordonnées de Contact</h4>
    <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
      <label>Téléphone Mobile :</label> <p id="profile-phone"></p>
      <label>Email de Contact :</label> <p id="profile-email"></p>
      <label>Adresse Postale :</label> <p id="profile-address"></p>
    </div>
  </div>
  
  <div class="account-block" style="margin-top: 20px;">
    <h4>RIB (Accès Rapide)</h4>
     <div class="form-grid" style="grid-template-columns: 1fr 2fr;">
      <label>RIB (IBAN) :</label> <p id="profile-rib"></p>
      <label>BIC (SWIFT) :</label> <p id="profile-bic"></p>
    </div>
    <a href="rib.html"><button class="btn btn-primary" style="margin-top: 15px;">Détails & Impression du RIB</button></a>
  </div>
</main>

<aside class="right-panel">
  <a href="dashboard.html"><button>Synthèse des comptes</button></a>
  <a href="virement.html"><button>Faire un virement</button></a>
  <a href="mes-cartes.html"><button>Gérer mes cartes</button></a>
  <button class="sav">VOTRE ESPACE SAV</button>
</aside>

<footer>
  <p>© BANQUE DE FRANCE - 39 Rue Croix des Petits Champs, 75001 Paris, France</p>
</footer>
<script>

// Variable globale pour stocker les données utilisateur
let currentUserData = null;

// Fonction pour mettre à jour l'UI avec les données du profil
function displayProfileData(user) {
    // Utilisation de la logique de nom du shared.js
    const nameParts = user.name.split(' ');
    const display = nameParts.length > 1 ? `${nameParts[0]} ${nameParts[1]}` : user.name;
    
    document.getElementById('user-name-header').textContent = display;
    document.getElementById('client-solde').textContent = formatCurrency(user.solde);
    document.getElementById('advisor-name').textContent = user.advisor || 'Non attribué';
    document.getElementById('last-conn').textContent = `Dernière connexion le ${user.lastConnection}`;

    document.getElementById('profile-name').textContent = user.name;
    document.getElementById('profile-client-code').textContent = user.clientCode;
    document.getElementById('profile-advisor').textContent = user.advisor || 'Non renseigné';
    document.getElementById('profile-phone').textContent = user.phone || 'Non renseigné';
    document.getElementById('profile-email').textContent = user.email || 'Non renseigné';
    document.getElementById('profile-address').textContent = user.address || 'Non renseigné';
    document.getElementById('profile-rib').textContent = user.rib || 'Non renseigné';
    document.getElementById('profile-bic').textContent = user.bic || 'Non renseigné';
}

document.addEventListener('DOMContentLoaded', async () => {
    // 1. Charger les données fraîches de Firebase
    // ⚠️ CORRECTION : Utilisation de la fonction checkAuth (corrigée dans shared.js)
    const user = await checkAuth(); 
    
    if (user) {
        currentUserData = user;
        displayProfileData(user);
    } else {
        // Redirection gérée par checkAuth()
        return;
    }

    // 2. Logique de changement de PIN
    const pinForm = document.getElementById('pin-form');
    const newPinInput = document.getElementById('new-pin');
    const pinMessage = document.getElementById('pin-message');
    const pinSubmitBtn = document.getElementById('pin-submit-btn');

    pinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newPin = newPinInput.value;
        
        if (!/^\d{6}$/.test(newPin)) {
            pinMessage.className = 'error-message';
            pinMessage.textContent = 'Le PIN doit être composé de 6 chiffres.';
            pinMessage.style.display = 'block';
            return;
        }
        
        if (!currentUserData) {
            pinMessage.className = 'error-message';
            pinMessage.textContent = 'Erreur: Données utilisateur introuvables. Réessayez.';
            pinMessage.style.display = 'block';
            return;
        }
        
        // Sauvegarde du PIN (le PIN est stocké en clair pour la simulation)
        pinSubmitBtn.disabled = true;
        pinSubmitBtn.textContent = 'Mise à jour en cours...';
        pinMessage.style.display = 'none';

        try {
            // Mettre à jour la propriété PIN et sauvegarder dans Firestore
            currentUserData.pin = newPin;
            
            // ⚠️ CORRECTION : Utilisation de la fonction updateUser (disponible dans shared.js)
            const success = await updateUser(currentUserData); 
            
            if (success) {
                pinMessage.className = 'success-message';
                pinMessage.textContent = 'Votre code PIN a été mis à jour avec succès.';
                pinMessage.style.display = 'block';
                newPinInput.value = ''; // Effacer le champ après succès
            } else {
                throw new Error("Échec de la sauvegarde.");
            }
            
        } catch (error) {
            console.error("Erreur lors de la mise à jour du PIN:", error);
            pinMessage.className = 'error-message';
            pinMessage.textContent = 'Erreur de connexion/sauvegarde. Impossible de changer le PIN.';
            pinMessage.style.display = 'block';
        } finally {
            pinSubmitBtn.disabled = false;
            pinSubmitBtn.textContent = 'Changer le PIN';
        }
    });
});
</script>
</body>
</html>