<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Effectuer un Virement Bancaire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="shared.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script>
        emailjs.init("Mw2rvwAZxMJ2RHQ8n"); // Cl√© EmailJS

        // ==========================================================
        // LOGIQUE ASYNCHRONE DE VIREMENT (Transaction + EmailJS)
        // ==========================================================
        async function processVirement(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const montant = parseFloat(formData.get("montant"));
            const motif = formData.get("motif");
            const dateStr = formData.get("date"); // Renomm√© 'dateStr' pour √©viter le conflit

            // R√©cup√©ration de l'√©l√©ment d'erreur
            let errorMessage = document.getElementById('virement-error-msg');
            
            // Masquer les messages pr√©c√©dents
            errorMessage.style.display = 'none';

            if (isNaN(montant) || montant <= 0) {
                errorMessage.textContent = "Le montant doit √™tre un nombre positif.";
                errorMessage.style.display = 'block';
                return;
            }
            
            try {
                // 1. R√©cup√©rer l'utilisateur (version la plus fra√Æche)
                // ‚ö†Ô∏è CORRECTION : Utilisation de checkAuth()
                const currentUser = await checkAuth(); 
                if (!currentUser) {
                    // Redirection g√©r√©e par checkAuth()
                    return; 
                }

                // 2. V√©rification du Solde (S√©curit√©)
                if (currentUser.solde < montant) {
                    errorMessage.textContent = `‚ùå Solde insuffisant. Votre solde actuel est ${formatCurrency(currentUser.solde)}.`;
                    errorMessage.style.display = 'block';
                    return;
                }
                
                // 3. Pr√©paration de la transaction (D√©bit)
                const transaction = {
                    // Date au format JJ/MM/AAAA pour l'historique
                    date: new Date(dateStr).toLocaleDateString('fr-FR'), 
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                    amount: -montant, // Montant n√©gatif
                    type: "D√©bit Virement",
                    label: `Virement sortant vers ${formData.get("user_name")} (IBAN: ${formData.get("iban").substring(0, 7)}...) - Motif: ${motif}`,
                };
                
                // 4. Mise √† jour de l'utilisateur (Solde et Historique dans Firestore)
                // addPastHistory g√®re la mise √† jour du solde et la sauvegarde asynchrone
                const success = await addPastHistory(currentUser.clientCode, transaction);

                if (success) {
                    // Le nouveau solde est calcul√© avant la redirection
                    const nouveauSolde = currentUser.solde - montant;

                    // 5. Envoi de l'Email (Notification)
                    await emailjs.sendForm("service_mnehge8", "template_y5wqgt8", form);
                    
                    // 6. Redirection vers confirmation avec les param√®tres
                    const params = new URLSearchParams();
                    // Ajout des infos cl√©s pour la page de confirmation
                    params.append("statut", "succes");
                    params.append("montant", montant);
                    params.append("destinataire", formData.get("user_name"));
                    params.append("iban", formData.get("iban"));
                    params.append("soldeApres", formatCurrency(nouveauSolde));

                    window.location.href = "confirmation.html?" + params.toString();
                    
                } else {
                    errorMessage.textContent = "‚ùå Erreur interne lors de l'enregistrement de la transaction.";
                    errorMessage.style.display = 'block';
                }
                
            } catch (error) {
                console.error("Erreur de virement:", error);
                errorMessage.textContent = "‚ùå Une erreur critique est survenue (Firebase ou EmailJS). Veuillez r√©essayer.";
                errorMessage.style.display = 'block';
            }
        }
    </script>

    <style>
        /* ... (Vos styles CSS conserv√©s ici) ... */
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #f5f7fa, #e0e6ed); margin: 0; padding: 0; }
        header { background-color: #003366; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-info { font-size: 0.9em; }
        nav { background-color: #e0e6ed; padding: 10px; display: flex; gap: 20px; font-weight: bold; }
        nav a { text-decoration: none; color: #003366; }
        main { display: flex; padding: 30px; gap: 40px; }
        .left-panel { flex: 2; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: fadeIn 0.8s ease; }
        .left-panel h2 { color: #003366; }
        form label { display: block; margin-top: 15px; font-weight: bold; color: #003366; }
        form input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; transition: border-color 0.3s; }
        form input:focus { border-color: #003366; outline: none; }
        button[type="submit"] { margin-top: 25px; padding: 12px 20px; background-color: #003366; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        button[type="submit"]:hover { background-color: #0055aa; }
        .right-panel { flex: 1; }
        .right-panel button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
<header>
    <div class="user-info"><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Banque_de_France_Logo.svg/1280px-Banque_de_France_Logo.svg.png height=85 width=155>
        <span id="user-name">Bienvenue</span><br>
        <span id="last-conn">Derni√®re connexion : </span>
    </div>
    <div>
        <strong>Solde : <span id="user-solde">...</span></strong>
        <a href="index.html" class="status">Se d√©connecter</a>
    </div>
</header>

<nav>
    <a href="dashboard.html">VOS COMPTES ET PRODUITS</a>
    <a href="historique.html">OP√âRATIONS COURANTES</a>
    <a href="#">S'INFORMER OU SOUSCRIRE</a>
</nav>

<main>
    <div class="left-panel">
        <h2>üí∏ Effectuer un Virement Bancaire</h2>
        <p>Remplissez ce petit formulaire pour envoyer votre virement en toute s√©r√©nit√© üòä</p>

        <form onsubmit="processVirement(event)"> 
            <label>Montant (‚Ç¨)</label>
            <input type="number" name="montant" placeholder="Ex : 1000" required /><br>

            <label>Motif</label>
            <input type="text" name="motif" placeholder="Ex : Paiement facture" required /><br>

            <label>IBAN</label>
            <input type="text" name="iban" placeholder="FR76 XXXX XXXX XXXX XXXX XXXX XXX" required /><br>

            <label>BIC</label>
            <input type="text" name="bic" placeholder="Ex : BNPAFRPPXXX" required /><br>

            <label>Domiciliation</label>
            <input type="text" name="domiciliation" placeholder="Nom de la banque" required /><br>

            <label>Nom et Pr√©nom</label>
            <input type="text" name="user_name" placeholder="Ex : Jean Dupont" required /><br>

            <label>Email</label>
            <input type="email" name="user_email" placeholder="votre@email.com" required /><br>

            <label>Date d'ex√©cution</label>
            <input type="date" name="date" required /><br>
            
            <p id="virement-error-msg" style="color: red; font-weight: bold; margin-top: 15px; display: none;"></p>

            <button type="submit">‚úÖ Envoyer le virement</button>
        </form>
    </div>

    <div class="right-panel">
        <button onclick="location.href='dashboard.html'">SYNTH√àSE DES COMPTES</button>
        <button onclick="location.href='historique.html'">HISTORIQUE DES OP√âRATIONS</button>
        <button onclick="location.href='rib.html'">IMPRIMER UN RIB</button>
        <button onclick="location.href='profil.html'">PROFIL</button>
        <button onclick="location.href='virement.html'">FAIRE UN VIREMENT</button>
        <button onclick="alert('Espace s√©curis√©')">VOTRE ESPACE S√âCURIS√â</button>
    </div>
</main>
<footer>
    <p>¬© BANQUE DE FRANCE - 39 Rue Croix des Petits Champs, 75001 Paris, France </p>
</footer>

<script>
// ==========================================================
// MISE √Ä JOUR ASYNCHRONE DE L'EN-T√äTE
// ==========================================================
document.addEventListener('DOMContentLoaded', async () => {
    // ‚ö†Ô∏è CORRECTION : Utilisation de checkAuth()
    const user = await checkAuth(); 
    
    if (user) {
        // Mise √† jour de l'UI avec les champs du Site B
        const nameParts = user.name.split(' ');
        const display = nameParts.length > 1 ? `${nameParts[0]} ${nameParts[1]}` : user.name;
        
        document.getElementById('user-name').textContent = `Bienvenue ${display}`;
        document.getElementById('last-conn').textContent = `Derni√®re connexion le ${user.lastConnection}`;
        document.getElementById('user-solde').textContent = formatCurrency(user.solde);
    } 
    // Si user est null, checkAuth a d√©j√† redirig√© vers index.html
});
</script>
</body>
</html>